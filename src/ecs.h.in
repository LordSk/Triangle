#pragma once
#include "utils.h"
#include "basic_components.h"

struct ComponentBit
{
    enum Enum: i32 {
        Null = 0,
%%ENUM_COMPONENT%%
    };
};

#define MAX_ENTITIES 2048

struct EntityComponentSystem
{
    u64 entityCompBits[MAX_ENTITIES] = {};
    bool8 entityDeleteFlag[MAX_ENTITIES] = {0};
%%ARRAY_COMPONENT%%

    i32 createEntity();
    void deleteEntity(const i32 eid);
    void update(f64 delta, f64 physLerpAlpha);
    void removeFlaggedForDeletion();

#define ADD_FUNC(COMP)\
    inline auto& addComp##COMP(const i32 eid) {\
        assert(eid >= 0 && eid < MAX_ENTITIES);\
        entityCompBits[eid] |= ComponentBit::COMP;\
        return comp_##COMP.emplace(eid, {});\
    }

%%ADD_COMPONENT%%

#undef ADD_FUNC

    // fancy template getter
    template<typename T>
    inline T& getComp(const i32 eid) {
        return _getComp_imp<T>(eid);
    }

    template<typename T>
    inline auto& _getComp_imp(const i32 eid) {
        assert(0);
    }
};

// template specialization for fancy getter
#define GETTER_FUNC(COMP) template<>\
inline auto& EntityComponentSystem::_getComp_imp<C##COMP>(const i32 eid) {\
    assert(eid >= 0 && eid < MAX_ENTITIES);\
    return comp_##COMP[eid];\
}

%%GETTER_COMPONENT%%

#undef GETTER_FUNC
